---
import IndexLayout from '@/layouts/IndexLayout.astro'
import PostList from '@/components/widgets/PostList.astro'
import { themeConfig } from '@/config'
import { getSortedFilteredPosts } from '@/utils/draft'

export async function getStaticPaths() {
  const posts = await getSortedFilteredPosts()

  // Collect all unique tags
  const allTags = new Set<string>()
  posts.forEach((post) => {
    if (post.data.tags && Array.isArray(post.data.tags)) {
      post.data.tags.forEach((tag: string) => allTags.add(tag))
    }
  })

  // Create a path for each tag
  return Array.from(allTags).map((tag) => {
    const filteredPosts = posts.filter(
      (post) => post.data.tags && post.data.tags.includes(tag)
    )
    return {
      params: { tag },
      props: { posts: filteredPosts, tag }
    }
  })
}

const { posts, tag } = Astro.props
const pageTitle = `Posts tagged with "${tag}"`
---

<IndexLayout title={`${tag} Â· ${themeConfig.site.title}`} description={pageTitle}>
  <main>
    <div class="tag-header">
      <h1>#{tag}</h1>
      <p class="tag-count">{posts.length} {posts.length === 1 ? 'post' : 'posts'}</p>
    </div>
    <PostList posts={posts} />
  </main>
</IndexLayout>

<style>
  .tag-header {
    margin-bottom: 2rem;
  }

  .tag-header h1 {
    font-size: 1.5rem;
    margin: 0 0 0.5rem 0;
    font-weight: 600;
  }

  .tag-count {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
  }
</style>
